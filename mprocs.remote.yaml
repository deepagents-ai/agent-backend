# mprocs configuration for remote backend testing with Docker
# Usage: mprocs -c mprocs.remote.yaml (or make dev-remote)
#
# This simulates a remote backend deployment locally using Docker.
# The Docker container runs the agent-backend MCP server, and NextJS
# connects to it as if it were a remote host.

procs:
  typescript-watch:
    cmd: ["pnpm", "run", "dev"]
    cwd: "typescript"
    stop: "SIGTERM"
    env:
      FORCE_COLOR: "1"

  # Docker container running agent-backend MCP server
  # Simulates a remote host with direct filesystem access
  remote-mcp-server:
    shell: |
      docker run --rm \
        --name agent-backend-remote \
        -p 3001:3001 \
        -p 2222:22 \
        -v "$(pwd)/tmp/remote-workspace:/workspace" \
        -e MCP_PORT=3001 \
        agent-backend:latest \
        sh -c "agent-backend --backend local --rootDir /workspace --http-port 3001"
    stop: "SIGTERM"
    env:
      FORCE_COLOR: "1"

  # NextJS dev server configured for remote backend
  nextjs-remote-mode:
    cmd: ["pnpm", "run", "dev"]
    cwd: "examples/NextJS"
    stop: "SIGTERM"
    env:
      FORCE_COLOR: "1"
      # Configure for remote backend mode
      NEXT_PUBLIC_BACKEND_TYPE: "remote"
      REMOTE_MCP_URL: "http://localhost:3001"
      AGENTBE_WORKSPACE_ROOT: "/workspace"
      # SSH credentials for remote backend (optional, for file operations)
      REMOTE_VM_HOST: "localhost"
      REMOTE_VM_PORT: "2222"
      REMOTE_VM_USER: "root"
      REMOTE_VM_PASSWORD: "agents"
    # Wait for remote MCP server to be ready
    depends_on:
      remote-mcp-server:
        condition: "running"
      typescript-watch:
        condition: "running"

  # Optional: Watch docker logs separately for debugging
  # docker-logs:
  #   shell: "docker logs -f agent-backend-remote 2>&1"
  #   stop:
  #     send_signal:
  #       signal: "SIGTERM"
