# agentbe-daemon Docker Compose
#
# Usage (from this directory):
#   cp ../../../.env.example ../../../.env  # First time only
#   docker-compose up -d
#   docker-compose logs -f
#   docker-compose down
#
# Or use `make dev-remote` from monorepo root (recommended for development)
#
# Transport modes:
#   - SSH-WS (default): SSH over WebSocket on MCP port (single port, unified auth)
#   - Conventional SSH (opt-in): Traditional sshd on port 22 (CONVENTIONAL_SSH=true)
#
# Environment variables (set in .env or export):
#   AUTH_TOKEN     - Unified auth token for MCP and SSH-WS (recommended)
#   MCP_PORT       - MCP + SSH-WS server port (default: 3001)
#   DISABLE_SSH_WS - Set to "true" to disable SSH-WS endpoint
#
# Conventional SSH (opt-in, requires CONVENTIONAL_SSH=true):
#   SSH_HOST_PORT  - Host port for SSH (default: 2222)
#   SSH_PORT       - Container SSH port (default: 22)
#   SSH_USERS      - Comma-separated user:pass pairs (default: root:agents)

services:
  agentbe-daemon:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.runtime
    image: agentbe-daemon:latest
    container_name: agentbe-daemon
    ports:
      # MCP + SSH-WS (always exposed)
      - "${MCP_PORT:-3001}:${MCP_PORT:-3001}"
      # Conventional SSH (only used if CONVENTIONAL_SSH=true)
      - "${SSH_HOST_PORT:-2222}:${SSH_PORT:-22}"
    volumes:
      - ./var/workspace:/var/workspace
      # Uncomment for SSH key auth (conventional SSH only):
      # - ./keys:/keys:ro
    env_file:
      - ../../../.env
    environment:
      - MCP_PORT=${MCP_PORT:-3001}
      # SSH-WS is enabled by default. Uncomment to enable conventional SSH:
      # - CONVENTIONAL_SSH=true
      # - SSH_PORT=${SSH_PORT:-22}
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${MCP_PORT:-3001}/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
