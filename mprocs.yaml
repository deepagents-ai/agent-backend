# Agent Backend Development
#
# Processes:
#   agentbe-local   - Daemon on host via tsx --watch (no Docker)
#   agentbe-daemon  - Daemon in Docker container via tsx --watch (simulates remote)
#   nextjs          - NextJS example app
#   pybasic         - PyBasic CLI example app
#
# Usage:
#   make dev                 - Docker daemon (default)
#   make dev-local           - Local daemon (no Docker)
#   make example-nextjs      - Docker daemon + NextJS
#
# Or directly:
#   mprocs                           - agentbe-daemon (Docker)
#   LOCAL=1 mprocs                   - agentbe-local (no Docker)
#   NEXTJS=1 mprocs                  - agentbe-daemon + NextJS
#   PYBASIC=1 mprocs                 - agentbe-daemon + PyBasic
#   LOCAL=1 NEXTJS=1 mprocs          - agentbe-local + NextJS
#
# TUI shortcuts:
#   Tab/Shift+Tab - cycle processes
#   Space - start/stop process
#   r - restart
#   f - focus (full screen)
#   q - quit

procs:
  # Local daemon — runs directly on host, no Docker
  # Enable with LOCAL=1
  agentbe-local:
    shell: |
      [ -z "$LOCAL" ] && echo "Skipped (set LOCAL=1 to enable)" && exit 0
      echo "Starting agentbe-daemon locally (tsx --watch)..."
      cd typescript
      exec npx tsx --watch src/cli.ts daemon \
        --rootDir /tmp/agent-backend-workspace \
        --local-only
    stop: "SIGTERM"
    env:
      FORCE_COLOR: "1"

  # Docker daemon — simulates remote deployment
  # Runs by default; skip with LOCAL=1
  # Mounts TypeScript source into container; tsx --watch handles hot-reload
  agentbe-daemon:
    shell: |
      [ "$LOCAL" = "1" ] && echo "Skipped (LOCAL=1, using agentbe-local)" && exit 0

      # Trap signals to properly stop container
      cleanup() {
        echo "Stopping container..."
        docker stop agentbe-daemon 2>/dev/null || true
        exit 0
      }
      trap cleanup SIGINT SIGTERM

      # Clean up any existing container first
      docker stop agentbe-daemon 2>/dev/null || true
      docker rm agentbe-daemon 2>/dev/null || true

      # Do initial deploy (sets up node_modules for the container)
      echo "Creating standalone deploy folder..."
      rm -rf tmp/deploy
      pnpm --filter=agent-backend deploy --prod --legacy tmp/deploy

      # Start container in background so trap can catch signals
      ENV_FILE=".env.example"
      [ -f ".env" ] && ENV_FILE=".env"
      echo "Starting container (tsx --watch on mounted source)..."
      docker run --rm \
        --name agentbe-daemon \
        -p 3001:3001 \
        -p 2222:22 \
        -v "$(pwd)/tmp/deploy:/app/agent-backend:ro" \
        -v "$(pwd)/typescript/src:/app/agent-backend/src:ro" \
        -e USE_LOCAL_BUILD=1 \
        --env-file "$ENV_FILE" \
        agentbe-daemon:latest &

      # Wait for container (allows trap to work)
      wait
    stop: "SIGTERM"
    env:
      FORCE_COLOR: "1"

  # NextJS example app
  # Skipped by default; enable with NEXTJS=1
  nextjs:
    shell: |
      [ -z "$NEXTJS" ] && echo "Skipped (set NEXTJS=1 to enable)" && exit 0
      exec pnpm run dev
    cwd: "examples/NextJS"
    stop: "SIGTERM"
    env:
      FORCE_COLOR: "1"

  # PyBasic CLI example app
  # Skipped by default; enable with PYBASIC=1
  pybasic:
    shell: |
      [ -z "$PYBASIC" ] && echo "Skipped (set PYBASIC=1 to enable)" && exit 0
      cd examples/PyBasic
      exec uv run python main.py
    stop: "SIGTERM"
    env:
      FORCE_COLOR: "1"
